name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  # Semver (e.g. 5.13.1)
  QT_VERSION: 5.13.1

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      with:
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v1
      with:
        python-version: 3.7

    - name: Install Qt
      run: |
        sudo apt-get update
        sudo apt-get install unzip wget build-essential mesa-common-dev libglu1-mesa-dev -y
        python -m pip install --upgrade pip
        sudo pip3 install aqtinstall
        export QT_INSTALL_DIR=$HOME/Qt
        mkdir $QT_INSTALL_DIR
        sudo aqt install --outputdir $QT_INSTALL_DIR $QT_VERSION linux desktop -m qtcharts

    - name: Build app and run tests
      run: |
        export QTDIR=$HOME/Qt/$QT_VERSION/gcc_64
        $QTDIR/bin/qmake CONFIG+=release
        make -j`nproc`
        export RRCORE=$PWD/src/rrcore
        export LD_LIBRARY_PATH=$QTDIR/lib
        export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$RRCORE
        export QT_QPA_PLATFORM=offscreen
        make check
        
